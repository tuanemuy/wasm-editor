# コアアーキテクチャ コードレビュー

日時: 2025-10-11 23:48
レビュー対象: コアアーキテクチャ実装

## 総評

全体として、ヘキサゴナルアーキテクチャの原則は適切に守られています。ドメイン層が外部依存を持たず、ポートインターフェースが明確に定義され、アダプター層がポートを実装し、アプリケーション層がコンテキストを通じて依存性注入を受けています。すべての関数が `Result` 型を返しており、エラーハンドリングも適切です。

## 修正が必要な問題点

### 1. Asset ドメイン - AssetStorageManager の実装が欠落

**ファイル**: `app/core/adapters/fileSystemAccess/assetStorageManager.ts` (未作成)

**問題**: `AssetStorageManager` インターフェースの具体的実装が存在しません。

**必要な対応**:
- File System Access API を使用した実装を作成
- `save()`, `read()`, `delete()`, `getUrl()` メソッドの実装
- 画像ファイルの保存、読み込み、削除、URL取得機能の実装

### 2. Asset ドメイン - uploadImage の入力パラメータが仕様と異なる

**ファイル**: `app/core/application/asset/uploadImage.ts:12`

**問題**: `UploadImageInput` に `destinationPath` パラメータが含まれていますが、仕様では `noteId` と `file` のみです。

**修正内容**:
- `destinationPath` パラメータを削除
- UUID + 拡張子でファイル名を生成するロジックを内部に追加
- 仕様: `assets/images/${UUID}.${extension}` 形式でパスを自動生成

## 確認が推奨される項目

### 1. Export ドメイン - MarkdownExporter の実装詳細

**ファイル**: `app/core/adapters/markdownExporter/markdownExporter.ts`

**確認内容**:
- 実装は存在するが、詳細な動作の確認が必要
- ノートの内容が正しくMarkdown形式に変換されているか
- 画像参照のパス処理が適切か

### 2. Export ドメイン - ExportStorageManager の実装

**ファイル**: `app/core/adapters/fileSystemAccess/exportFileSystemManager.ts`

**確認内容**:
- `save()` メソッドが簡易版（ダウンロードトリガー）の可能性
- 仕様では指定パスへの保存が求められている可能性があるため確認が必要

### 3. Database ドメイン - DatabaseManager の実装詳細

**ファイル**: `app/core/adapters/tursoDatabaseWasm/databaseManager.ts`

**確認内容**:
- 実装は存在するが、詳細な動作の確認が必要
- @tursodatabase/database-wasm との統合が適切か
- File System Access API との連携が正しく動作するか

## ドメイン別レビュー結果

### Note ドメイン

✅ **問題なし**

- Domain Layer: 完全実装
- Adapter Layer: 完全実装
- Application Layer: 全9ユースケース実装済み
  - createNote, getNote, getNotes, updateNote, deleteNote
  - searchNotes, searchNotesByTags, combinedSearch, getTags

### Asset ドメイン

⚠️ **修正必要**

- Domain Layer: 完全実装
- Adapter Layer: AssetStorageManager の実装が欠落
- Application Layer: uploadImage のパラメータ修正が必要

その他の実装済みユースケース:
- getAsset, getAssetsByNoteId, deleteAsset, getImageUrl

### Database ドメイン

⚠️ **確認推奨**

- Domain Layer: 完全実装
- Adapter Layer: 実装存在（詳細確認推奨）
- Application Layer: 全5ユースケース実装済み
  - createDatabase, openDatabase, closeDatabase
  - getDatabasePath, changeDatabasePath

### Export ドメイン

⚠️ **確認推奨**

- Domain Layer: 完全実装
- Adapter Layer: 実装存在（詳細確認推奨）
- Application Layer: 全2ユースケース実装済み
  - exportNoteAsMarkdown, exportNotesAsMarkdown

### Revision ドメイン

✅ **問題なし**

- Domain Layer: 完全実装
- Adapter Layer: 完全実装
- Application Layer: 全4ユースケース実装済み
  - saveRevision, getRevisions, getRevision, restoreRevision

### Settings ドメイン

✅ **問題なし**

- Domain Layer: 完全実装
- Adapter Layer: 完全実装
- Application Layer: 全2ユースケース実装済み
  - getSettings, updateSettings

## データベーススキーマ

✅ **問題なし**

**ファイル**: `app/core/adapters/drizzleSqlite/schema.ts`

すべてのテーブルが仕様通りに定義されています:
- notes テーブル
- tags テーブル
- note_tags テーブル（複合主キー、CASCADE DELETE）
- revisions テーブル（インデックス付き）
- assets テーブル（インデックス付き）
- settings テーブル（シングルトンパターン）
- database_metadata テーブル

## エラーハンドリング

✅ **問題なし**

- `app/core/error/domain.ts`: DomainError 実装済み
- `app/core/error/adapter.ts`: RepositoryError、ExternalServiceError 実装済み
- `app/core/error/application.ts`: ApplicationError 実装済み

すべての関数が `Result<T, E>` 型を返しています。

## コンテキストオブジェクト

✅ **問題なし**

**ファイル**: `app/core/application/context.ts`

すべての必要な依存関係が定義されています:
- データベース接続
- 各リポジトリ（Note, Tag, Asset, Revision, Settings）
- 各ストレージマネージャー（Asset, Database, Export）
- トランザクションサポート

## アーキテクチャ遵守状況

✅ **ヘキサゴナルアーキテクチャの原則を遵守**

- ✅ ドメイン層が外部依存を持たない
- ✅ ポートインターフェースが明確に定義されている
- ✅ アダプター層がポートを実装している
- ✅ アプリケーション層がコンテキストを通じて依存性注入を受けている
- ✅ すべての関数が `Result` 型を返している
- ✅ 依存関係の方向が適切（Domain ← Application ← Adapter）

## 優先度別対応事項

### 優先度：高（必須）

1. `AssetStorageManager` の実装を作成
2. `uploadImage` の入力パラメータを修正

### 優先度：中（推奨）

1. `MarkdownExporter` の動作確認
2. `ExportStorageManager.save()` の実装確認
3. `DatabaseManager` の動作確認

## まとめ

コアアーキテクチャの実装は全体として良好です。必須の修正事項は2件のみで、残りは確認推奨事項です。アーキテクチャの原則は適切に守られており、型安全性も確保されています。
