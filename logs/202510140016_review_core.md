# コアアーキテクチャのコードレビュー

**レビュー日時:** 2025-10-14 00:16
**対象:** コアアーキテクチャ（ドメイン層、アダプター層、アプリケーション層）

## 総評

実装は設計に完全に従っており、ヘキサゴナルアーキテクチャとドメイン駆動設計（DDD）の原則が適切に適用されている。コードの品質は高く、各層の責務が明確に分離されている。

## ドメイン層

### Note ドメイン

**エンティティ (app/core/domain/note/entity.ts)**
- ✅ 仕様通りに実装
- ✅ 不変性を維持（Readonlyを使用）
- ✅ createNote, updateContent, updateTagIds が正しく実装
- ✅ tagIds の重複排除（Set による）が実装済み

**値オブジェクト (app/core/domain/note/valueObject.ts)**
- ✅ ブランド型を使用した型安全性の確保
- ✅ NoteContent のバリデーション（空文字、最大文字数）が実装済み
- ✅ SortOrder と OrderBy のバリデーションが実装済み

**ポート (app/core/domain/note/ports/)**
- ✅ NoteRepository: 基本的な CRUD 操作のインターフェースが設計通り
- ✅ NoteQueryService: 複雑な検索クエリのインターフェースが設計通り
- ✅ ExportPort: エクスポート機能のインターフェースが設計通り

**エラーコード (app/core/domain/note/errorCode.ts)**
- ✅ 仕様通りに定義

### Tag ドメイン

**エンティティ (app/core/domain/tag/entity.ts)**
- ✅ 仕様通りに実装
- ✅ createTag が正しく実装
- ✅ TagWithUsage DTO が定義済み

**値オブジェクト (app/core/domain/tag/valueObject.ts)**
- ✅ ブランド型を使用した型安全性の確保
- ✅ TagName のバリデーション（空文字、最大文字数、文字種）が実装済み
- ✅ 正規表現パターンが仕様通り

**ポート (app/core/domain/tag/ports/)**
- ✅ TagRepository: Tag 集約の永続化インターフェースが設計通り
- ✅ TagQueryService: 使用回数集計などの複雑なクエリのインターフェースが設計通り
- ✅ TagExtractorPort: タグ抽出のインターフェースが設計通り

**エラーコード (app/core/domain/tag/errorCode.ts)**
- ✅ 仕様通りに定義

### Settings ドメイン

**エンティティ (app/core/domain/settings/entity.ts)**
- ✅ 仕様通りに実装
- ✅ createDefaultSettings, updateSettings, resetSettings が正しく実装
- ✅ Note ドメインから SortOrder と OrderBy を import して使用

**値オブジェクト (app/core/domain/settings/valueObject.ts)**
- ✅ AutoSaveInterval のバリデーション（最小値、最大値）が実装済み

**ポート (app/core/domain/settings/ports/)**
- ✅ SettingsRepository: 設定の永続化インターフェースが設計通り

**エラーコード (app/core/domain/settings/errorCode.ts)**
- ✅ 仕様通りに定義

## アダプター層

### Drizzle SQLite アダプター

**スキーマ定義 (app/core/adapters/drizzleSqlite/schema.ts)**
- ✅ notes, tags, noteTagRelations テーブルが仕様通りに定義
- ✅ インデックスが適切に配置
- ✅ 外部キー制約と CASCADE DELETE が設定済み

**NoteRepository (app/core/adapters/drizzleSqlite/noteRepository.ts)**
- ✅ NoteRepository ポートを正しく実装
- ✅ into メソッドで tagIds を取得して Note エンティティを構築
- ✅ save メソッドで noteTagRelations を適切に管理
- ✅ エラーハンドリングが適切（NotFoundError, SystemError）

**NoteQueryService (app/core/adapters/drizzleSqlite/noteQueryService.ts)**
- ✅ NoteQueryService ポートを正しく実装
- ✅ combinedSearch で全文検索とタグ検索を組み合わせ
- ✅ タグの AND 検索が正しく実装（COUNT DISTINCT で実現）
- ✅ エラーハンドリングが適切

**TagRepository (app/core/adapters/drizzleSqlite/tagRepository.ts)**
- ✅ TagRepository ポートを正しく実装
- ✅ Tag 集約の永続化のみを担当（中間テーブルは管理しない）
- ✅ エラーハンドリングが適切

**TagQueryService (app/core/adapters/drizzleSqlite/tagQueryService.ts)**
- ✅ TagQueryService ポートを正しく実装
- ✅ findAllWithUsage で LEFT JOIN して使用回数を集計
- ✅ findUnused で未使用タグを検出
- ✅ エラーハンドリングが適切

**UnitOfWork (app/core/adapters/drizzleSqlite/unitOfWork.ts)**
- ✅ UnitOfWorkProvider を正しく実装
- ✅ トランザクション内で Repository インスタンスを生成

### Browser アダプター

**SettingsRepository (app/core/adapters/browser/settingsRepository.ts)**
- ✅ SettingsRepository ポートを正しく実装
- ✅ localStorage を使用して設定を永続化
- ✅ from/into メソッドでドメインエンティティとデータモデルを変換
- ✅ エラーハンドリングが適切

**TagExtractorPort (app/core/adapters/browser/tagExtractorPort.ts)**
- ✅ TagExtractorPort ポートを正しく実装
- ✅ 正規表現でタグを抽出（仕様通りのパターン）
- ✅ 重複排除（Set を使用）
- ✅ エラーハンドリングが適切

**ExportPort (app/core/adapters/browser/exportPort.ts)**
- ✅ ExportPort ポートを実装
- ✅ exportAsMarkdown が正しく実装（ファイル名生成、サニタイズ）
- ⚠️ **問題:** exportMultipleAsMarkdown が未実装（ZIP エクスポート機能）

## アプリケーション層

### エラー定義 (app/core/application/error.ts)
- ✅ NotFoundError, ConflictError, UnauthenticatedError, ForbiddenError, ValidationError, SystemError が定義済み
- ✅ エラーコードが適切に定義
- ✅ 設計に従った構造

### Context (app/core/application/context.ts)
- ✅ UnitOfWorkProvider と各種サービスを含む Context 型が定義済み
- ✅ 依存性注入のための構造が整っている

### UnitOfWork (app/core/application/unitOfWork.ts)
- ✅ Repositories 型と UnitOfWorkProvider インターフェースが定義済み
- ✅ 設計に従った構造

### Note ユースケース (app/core/application/note/)

**createNote.ts**
- ✅ 仕様通りに実装
- ✅ エンティティのファクトリー関数を使用してバリデーション
- ✅ UnitOfWork を使用してトランザクション管理

**updateNote.ts**
- ✅ 仕様通りに実装
- ✅ エンティティの操作関数を使用してバリデーション
- ✅ UnitOfWork を使用してトランザクション管理

**deleteNote.ts**
- ✅ 仕様通りに実装
- ✅ NotFoundError のハンドリングが適切

**getNote.ts, getNotes.ts**
- ✅ 仕様通りに実装

**combinedSearch.ts**
- ✅ 仕様通りに実装
- ✅ NoteQueryService を使用

**exportNoteAsMarkdown.ts, exportNotesAsMarkdown.ts**
- ✅ 仕様通りに実装

**searchNotesByTag.ts, searchNotesByTags.ts**
- ✅ 仕様通りに実装

### Tag ユースケース (app/core/application/tag/)

**syncNoteTags.ts**
- ✅ 仕様通りに実装
- ✅ タグの抽出、存在確認、作成、Note への関連付けが正しい
- ✅ UnitOfWork を使用してトランザクション管理

**cleanupUnusedTags.ts**
- ✅ 仕様通りに実装
- ✅ TagQueryService を使用して未使用タグを検出
- ✅ UnitOfWork を使用して削除

**getTags.ts**
- ✅ 仕様通りに実装
- ✅ TagQueryService を使用して使用回数付きタグを取得

**getTagsByNote.ts**
- ✅ 仕様通りに実装
- ✅ Note の tagIds から Tag エンティティを取得

**deleteTagsByNote.ts**
- ✅ 仕様通りに実装

### Settings ユースケース (app/core/application/settings/)

**getSettings.ts**
- ✅ 仕様通りに実装

**updateSettings.ts**
- ✅ 仕様通りに実装
- ✅ エンティティの操作関数を使用してバリデーション

**resetSettings.ts**
- ✅ 仕様通りに実装

## 問題点

### 1. ExportPort の未実装機能

**ファイル:** app/core/adapters/browser/exportPort.ts:86-98

**問題:**
- `exportMultipleAsMarkdown()` メソッドが未実装
- 現在は常に例外をスローする

**影響:**
- 複数メモの一括エクスポート機能（ZIP形式）が使用できない
- 要件 FR-EXPORT-003 に対応していない

**推奨対応:**
- JSZip ライブラリをインストール
- `exportMultipleAsMarkdown()` を実装してZIPファイルを生成

## 設計原則の遵守状況

### ヘキサゴナルアーキテクチャ
- ✅ ドメイン層が外部依存を持たない
- ✅ ポート/アダプターパターンが適切に実装
- ✅ アダプターがドメイン層のインターフェースを実装

### ドメイン駆動設計（DDD）
- ✅ エンティティと値オブジェクトが明確に分離
- ✅ 集約ルート（Note, Tag, Settings）が適切に設計
- ✅ ビジネスルールがドメイン層に集約

### リポジトリパターン
- ✅ Repository は集約の永続化のみを担当
- ✅ 複雑なクエリは QueryService に分離
- ✅ 中間テーブルが実装詳細として隠蔽

### エラーハンドリング
- ✅ ドメイン層で BusinessRuleError を使用
- ✅ アプリケーション層で適切なエラーに変換
- ✅ アダプター層で外部システムのエラーをキャッチして変換

### トランザクション管理
- ✅ UnitOfWork パターンが適切に実装
- ✅ 複数エンティティの更新がトランザクション内で実行

## まとめ

コアアーキテクチャの実装は非常に高品質であり、設計に完全に従っている。唯一の問題は ExportPort の ZIP エクスポート機能が未実装である点のみ。

今後の対応が必要な項目:
1. BrowserExportPort.exportMultipleAsMarkdown() の実装
