# コアアーキテクチャ コードレビュー

**日時**: 2025-10-11 21:30
**レビュー範囲**: コアアーキテクチャ（Domain層、Adapter層、Application層）

## レビュー対象

- `app/core/domain/` - ドメイン層
- `app/core/adapters/` - アダプター層
- `app/core/application/` - アプリケーション層
- `app/core/error/` - エラー定義

## 総合評価

実装は設計に従っており、ヘキサゴナルアーキテクチャの原則が適切に守られている。エンティティ、値オブジェクト、ポート、アダプター、アプリケーションサービスの分離が明確で、依存性注入も適切に実装されている。

## 問題点

### 1. Note ドメイン - タグの自動解析が未実装

**場所**: `app/core/domain/note/entity.ts:46-64`

**問題**:
createNote 関数でノートを作成する際、tags を空配列で初期化しているが、extractTagsFromContent 関数を呼び出していない。設計書では「タグは自動解析」と明記されており、updateNoteContent 関数では extractTagsFromContent が呼び出されている。

**現在のコード**:
```typescript
export function createNote(
  params: CreateNoteParams,
): Result<Note, ValidationError> {
  return validate(
    z.object({
      content: noteContentSchema,
    }),
    params,
  ).map((validated) => {
    const now = new Date();
    return {
      id: generateNoteId(),
      content: validated.content,
      tags: [], // タグの自動解析が行われていない
      createdAt: now,
      updatedAt: now,
    } satisfies Note;
  });
}
```

**影響**:
- ノート作成時に本文に含まれるタグが自動解析されず、tags プロパティが空のまま保存される
- ユーザーがタグ付きのノートを作成した場合、ノートを一度更新しないとタグが抽出されない

**修正案**:
```typescript
export function createNote(
  params: CreateNoteParams,
): Result<Note, ValidationError> {
  return validate(
    z.object({
      content: noteContentSchema,
    }),
    params,
  ).map((validated) => {
    const now = new Date();
    const tags = extractTagsFromContent(validated.content); // タグを自動解析
    return {
      id: generateNoteId(),
      content: validated.content,
      tags,
      createdAt: now,
      updatedAt: now,
    } satisfies Note;
  });
}
```

**優先度**: 高

---

## 設計との整合性

### アーキテクチャ構造

✅ **Domain層**
- エンティティ、値オブジェクト、ポートが適切に定義されている
- ビジネスロジックがドメインエンティティに集約されている
- 外部依存がポートとして抽象化されている

✅ **Adapter層**
- ポートの具象実装が適切に分離されている
- Drizzle ORM を使用したリポジトリ実装が適切
- File System Access API のアダプターも適切に実装

✅ **Application層**
- ユースケースがドメインロジックを呼び出す形で実装されている
- Context オブジェクトによる依存性注入が適切
- エラーハンドリングも neverthrow を使って適切に実装

### ドメインごとのレビュー

#### Note ドメイン

**エンティティ**: `app/core/domain/note/entity.ts`
- ✅ Note エンティティと Tag エンティティが適切に定義
- ✅ extractTagsFromContent 関数が適切に実装
- ⚠️ createNote 関数でタグの自動解析が未実装（上記問題点参照）
- ✅ updateNoteContent 関数では適切にタグを再解析

**値オブジェクト**: `app/core/domain/note/valueObject.ts`
- ✅ NoteId、NoteContent、TagName、SortBy が適切に定義
- ✅ バリデーションルールが設計通り実装

**ポート**: `app/core/domain/note/ports/`
- ✅ NoteRepository インターフェースが設計通り定義
- ✅ TagRepository インターフェースが設計通り定義
- ✅ すべてのメソッドが Result 型を返却

**アダプター**: `app/core/adapters/drizzleSqlite/noteRepository.ts`
- ✅ すべてのリポジトリメソッドが適切に実装
- ✅ タグ検索（複数タグのAND検索）が適切に実装
- ✅ 全文検索が LIKE を使用して実装（FTS5 は今後の拡張として検討）
- ✅ エラーハンドリングが適切

**アプリケーションサービス**: `app/core/application/note/`
- ✅ createNote、updateNote、deleteNote などが適切に実装
- ✅ エラーハンドリングが適切
- ✅ ドメインロジックの呼び出しが適切

#### Revision ドメイン

**エンティティ**: `app/core/domain/revision/entity.ts`
- ✅ Revision エンティティが適切に定義
- ✅ createRevision 関数が適切に実装

**アダプター**: `app/core/adapters/drizzleSqlite/revisionRepository.ts`
- 実装を確認する必要がある（レビュー範囲外）

#### Asset ドメイン

**エンティティ**: `app/core/domain/asset/entity.ts`
- ✅ Asset エンティティが適切に定義
- ✅ createAsset 関数でファイルサイズとMIMEタイプのバリデーションが適切に実装

**値オブジェクト**: `app/core/domain/asset/valueObject.ts`
- ✅ MAX_FILE_SIZE が 10MB に設定
- ✅ SUPPORTED_IMAGE_TYPES が適切に定義

**アプリケーションサービス**: `app/core/application/asset/uploadImage.ts`
- ✅ ファイル保存とDB保存が適切に実装
- ✅ 失敗時のクリーンアップ処理（ファイル削除）が適切に実装
- ✅ エラーハンドリングが適切

#### Database ドメイン

**エンティティ**: `app/core/domain/database/entity.ts`
- ✅ DatabaseConnection エンティティが適切に定義

**値オブジェクト**: `app/core/domain/database/valueObject.ts`
- 実装を確認する必要がある（レビュー範囲外）

#### Settings ドメイン

**エンティティ**: `app/core/domain/settings/entity.ts`
- ✅ Settings エンティティが適切に定義
- ✅ createDefaultSettings 関数が実装
- ✅ updateSettings 関数が部分更新に対応

**値オブジェクト**: `app/core/domain/settings/valueObject.ts`
- 実装を確認する必要がある（レビュー範囲外）

#### Export ドメイン

**ポート**: `app/core/domain/export/ports/`
- 実装を確認する必要がある（レビュー範囲外）

### データベーススキーマ

**スキーマ定義**: `app/core/adapters/drizzleSqlite/schema.ts`
- ✅ すべてのテーブルが設計通り定義
- ✅ 外部キー制約（CASCADE DELETE）が適切に設定
- ✅ インデックスが適切に定義（revisions_note_id_idx、assets_note_id_idx）
- ✅ timestamp の管理が適切（created_at、updated_at、saved_at）

### エラーハンドリング

**エラー型**: `app/core/error/`
- ✅ DomainError、AdapterError、ApplicationError が適切に定義
- ✅ RepositoryError と ExternalServiceError が AdapterError を継承
- ✅ すべてのエラーが AnyError を継承

**エラー処理**:
- ✅ すべてのバックエンド関数が Result 型を返却
- ✅ neverthrow を使用したエラーハンドリングが適切

### 依存性注入

**Context**: `app/core/application/context.ts`
- ✅ すべてのリポジトリとサービスが Context に含まれている
- ✅ withTransaction メソッドでトランザクション対応
- ✅ 各ドメインの FileSystemManager が適切に分離

---

## 推奨事項

### コードの改善

1. **タグの自動解析の実装**（優先度: 高）
   - createNote 関数で extractTagsFromContent を呼び出す

2. **全文検索の改善**（優先度: 中、将来的な拡張）
   - SQLite の FTS5 を使用した全文検索を実装
   - 日本語対応のトークナイザーを検討

3. **リビジョン数の制限**（優先度: 低、将来的な拡張）
   - ノートごとのリビジョン数を制限（例: 最新50件まで）
   - 古いリビジョンの自動削除機能

### テストの推奨

以下のテストを実装することを推奨:
- ユニットテスト: エンティティのファクトリ関数、ドメインメソッド
- 統合テスト: リポジトリの各メソッド
- E2Eテスト: ユースケースの正常系・異常系

---

## まとめ

コアアーキテクチャは全体的に設計に従って適切に実装されている。ヘキサゴナルアーキテクチャの原則が守られており、各層の責務が明確に分離されている。

**対応が必要な問題点**:
1. Note ドメインの createNote 関数でタグの自動解析を実装する

その他の実装は設計通りであり、コード品質も高い。
