# コアアーキテクチャのコードレビュー

レビュー日時: 2025-10-11 22:33

## レビュー概要

コアアーキテクチャ（ドメイン層、アダプター層、アプリケーション層）の実装を設計仕様に対してレビューしました。
全体としてヘキサゴナルアーキテクチャの原則に従っており、構造は良好ですが、いくつかの改善が必要な問題点が見つかりました。

---

## 対応が必要な問題点

### 1. 値オブジェクトの重複定義【高優先度】

**問題箇所:**
- `app/core/domain/asset/valueObject.ts:17-18` - NoteId の重複定義
- `app/core/domain/revision/valueObject.ts:15-18` - NoteId の重複定義
- `app/core/domain/revision/valueObject.ts:21-24` - NoteContent の重複定義

**問題内容:**
Asset ドメインと Revision ドメインで、Note ドメインの値オブジェクト（NoteId, NoteContent）を再定義しています。これは DRY 原則に違反しており、型の不一致やメンテナンス性の低下を招きます。

**推奨対応:**
Note ドメインから直接インポートするよう修正してください。

```typescript
// 修正前（app/core/domain/asset/valueObject.ts）
export const noteIdSchema = z.string().uuid().brand<"NoteId">();
export type NoteId = z.infer<typeof noteIdSchema>;

// 修正後
import type { NoteId } from "@/core/domain/note/valueObject";
```

---

### 2. FilePath の重複定義【中優先度】

**問題箇所:**
- `app/core/domain/database/valueObject.ts:11-13` - FilePath の定義
- `app/core/domain/asset/valueObject.ts:22-24` - FilePath の定義

**問題内容:**
FilePath が複数のドメインで重複定義されています。Database ドメインと Asset ドメインで同じ型を別々に定義しているため、型の互換性が失われています。

**推奨対応:**
共通の値オブジェクトとして `app/lib/valueObject.ts` などに定義し、各ドメインからインポートしてください。

---

### 3. TursoDatabaseManager の実装不備【高優先度】

**問題箇所:**
- `app/core/adapters/tursoDatabaseWasm/databaseManager.ts:183-258` - initializeSchema メソッド

**問題内容:**
`db.run()` メソッドを使用していますが、Drizzle ORM の API には `run()` メソッドが存在しません。正しくは `db.execute()` または `db.run()` ではなく適切な Drizzle の API を使用する必要があります。

また、以下のメソッドが未実装または不完全です：
- `serializeDatabase()` - 空の Uint8Array を返すだけで機能していません (line:130)
- `exportToFile()` - 実質的に何も実行していません (line:142-156)

**推奨対応:**
1. Drizzle ORM の正しい API を使用するよう修正してください
2. データベースのシリアライズとエクスポート機能を実装してください
3. または、これらの機能が不要であれば、ポート定義から削除してください

---

### 4. FileSystemManager ポートの重複定義【中優先度】

**問題箇所:**
- `app/core/domain/database/ports/fileSystemManager.ts`
- `app/core/domain/export/ports/fileSystemManager.ts`

**問題内容:**
FileSystemManager インターフェースが Database ドメインと Export ドメインで別々に定義されています。メソッド名は異なりますが、実質的に同じ File System Access API を扱うインターフェースであり、統合すべきです。

**推奨対応:**
共通のポートとして `app/core/domain/ports/fileSystemManager.ts` に統合し、両ドメインからインポートしてください。

---

### 5. DomainError が未使用【低優先度】

**問題箇所:**
- `app/core/error/domain.ts:6-8`

**問題内容:**
DomainError クラスが定義されていますが、実際のドメイン層では使用されていません。ドメイン層では主に ValidationError が使われています。

**推奨対応:**
DomainError を実際に使用するか、不要であれば削除してください。ドメインビジネスルール違反のエラーと ValidationError を区別する必要がある場合は、DomainError を使用することを推奨します。

---

### 6. Context の withTransaction 実装が未確認【中優先度】

**問題箇所:**
- `app/core/application/context.ts:31`

**問題内容:**
Context 型に `withTransaction` メソッドが定義されていますが、実際の実装（アダプターのインスタンス化を含む）が確認できませんでした。トランザクション管理は重要な機能であり、正しく実装されている必要があります。

**推奨対応:**
Context の実装ファイル（おそらく app/ 配下）を確認し、withTransaction が正しく実装されていることを確認してください。

---

### 7. データベーススキーマの timestamp 型の処理【低優先度】

**問題箇所:**
- `app/core/adapters/drizzleSqlite/schema.ts:22-23` - updatedAt の .$onUpdate()

**問題内容:**
`.$onUpdate(() => new Date())` が Drizzle ORM で期待通りに動作するか確認が必要です。SQLite では INTEGER 型として unixepoch を使用していますが、JavaScript の Date オブジェクトが自動的に変換されるかは実装依存です。

**推奨対応:**
実際にレコードを更新した際に updatedAt が正しく更新されることをテストで確認してください。

---

## その他の所見

### 良好な点

1. **ヘキサゴナルアーキテクチャの実装**
   - ドメイン層、アダプター層、アプリケーション層が明確に分離されています
   - ポートとアダプターのパターンが正しく実装されています

2. **型安全性**
   - Zod を使用したバリデーションが徹底されています
   - Brand 型を使用して型の誤用を防いでいます

3. **エラーハンドリング**
   - neverthrow の Result 型を使用して、エラー処理が型安全に行われています
   - 各層ごとにエラー型が定義されています

4. **ドメインモデルの実装**
   - エンティティのファクトリ関数や再構築関数が適切に実装されています
   - 値オブジェクトによるドメインルールの表現が明確です

5. **リポジトリの実装**
   - NoteRepository の実装が設計仕様に従っています
   - タグの自動解析、全文検索、複合検索などが実装されています

---

## 推奨される対応優先度

1. **高優先度** - 値オブジェクトの重複定義の解消（問題1）
2. **高優先度** - TursoDatabaseManager の実装修正（問題3）
3. **中優先度** - FilePath の重複定義の解消（問題2）
4. **中優先度** - FileSystemManager ポートの統合（問題4）
5. **中優先度** - Context の withTransaction 実装確認（問題6）
6. **低優先度** - DomainError の使用方針の明確化（問題5）
7. **低優先度** - timestamp 型の動作確認（問題7）

---

## まとめ

コアアーキテクチャの実装は全体的に良好で、設計仕様に従っています。しかし、値オブジェクトの重複定義や DatabaseManager の未実装メソッドなど、いくつかの問題が見つかりました。これらの問題を修正することで、コードの保守性と品質がさらに向上します。

特に高優先度の問題は早急に対応することを推奨します。
