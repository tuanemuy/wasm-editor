import fs from "node:fs/promises";
import path from "node:path";

const migrationsFolder = "./drizzle";
const outputFile = "./src/migrations.ts"; // SPAのソースコード内に出力

async function bundleMigrations() {
  try {
    const files = await fs.readdir(migrationsFolder);
    const sqlFiles = files.filter((file) => file.endsWith(".sql")).sort(); // ファイル名をソートして実行順を保証

    let content =
      "// This file is auto-generated by bundle-migrations.mjs. Do not edit directly.\n\n";
    content += "export const migrations = {\n";

    for (const file of sqlFiles) {
      const filePath = path.join(migrationsFolder, file);
      const sql = await fs.readFile(filePath, "utf-8");
      // SQL内のバッククォートをエスケープ
      const escapedSql = sql.replace(/`/g, "\\`");
      content += `  '${filePath}': \`${escapedSql}\`,\n`;
    }

    content += "};\n";

    await fs.writeFile(outputFile, content);
    console.log(`✅ Migrations bundled into ${outputFile}`);
  } catch (error) {
    console.error("❌ Failed to bundle migrations:", error);
    process.exit(1);
  }
}

bundleMigrations();
